{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/fauzan/.gemini/antigravity/playground/nomad-meteoroid/app/api/weather/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\nimport { WeatherData } from \"@/lib/types\";\n\nconst API_KEY = process.env.OPENWEATHER_API_KEY;\nconst BASE_URL = \"https://api.openweathermap.org/data/2.5\";\n\nexport async function GET(request: Request) {\n    const { searchParams } = new URL(request.url);\n    const city = searchParams.get(\"city\") || \"San Francisco\";\n\n    if (!API_KEY) {\n        console.warn(\"No API key found, returning mock data\");\n        return NextResponse.json(getMockData(city));\n    }\n\n    try {\n        // Fetch Current Weather\n        const currentRes = await fetch(\n            `${BASE_URL}/weather?q=${city}&units=metric&appid=${API_KEY}`\n        );\n\n        if (!currentRes.ok) {\n            if (currentRes.status === 404) {\n                return NextResponse.json({ error: \"City not found\" }, { status: 404 });\n            }\n            throw new Error(\"Failed to fetch current weather\");\n        }\n\n        const currentData = await currentRes.json();\n\n        // Fetch Forecast\n        const forecastRes = await fetch(\n            `${BASE_URL}/forecast?q=${city}&units=metric&appid=${API_KEY}`\n        );\n\n        if (!forecastRes.ok) {\n            throw new Error(\"Failed to fetch forecast\");\n        }\n\n        const forecastData = await forecastRes.json();\n\n        // The forecast API returns data in chronological order starting from the nearest available time\n        // Take the first 7 entries (we'll add current weather as the first entry)\n        const upcomingForecasts = forecastData.list.slice(0, 7);\n\n        // Create current weather entry for \"Now\"\n        const currentHourly = {\n            dt: Math.floor(Date.now() / 1000), // current timestamp\n            temp: Math.round(currentData.main.temp),\n            icon: currentData.weather[0].icon,\n        };\n\n        // Process Data\n        const weatherData: WeatherData = {\n            current: {\n                temp: Math.round(currentData.main.temp),\n                condition: currentData.weather[0].main,\n                description: currentData.weather[0].description,\n                high: Math.round(currentData.main.temp_max),\n                low: Math.round(currentData.main.temp_min),\n                city: currentData.name,\n                feelsLike: Math.round(currentData.main.feels_like),\n                humidity: currentData.main.humidity,\n                pressure: currentData.main.pressure,\n                windSpeed: currentData.wind.speed,\n                windDeg: currentData.wind.deg,\n                visibility: currentData.visibility,\n            },\n            hourly: [\n                currentHourly, // Add current weather as first entry\n                ...upcomingForecasts.map((item: any) => ({\n                    dt: item.dt,\n                    temp: Math.round(item.main.temp),\n                    icon: item.weather[0].icon,\n                }))\n            ],\n            daily: processDailyForecast(forecastData.list),\n            timezoneOffset: currentData.timezone, // timezone offset in seconds\n        };\n        return NextResponse.json(weatherData);\n    } catch (error) {\n        console.error(\"Weather API Error:\", error);\n        // Fallback to mock data on error if it's not a 404\n        return NextResponse.json(getMockData(city));\n    }\n}\n\nfunction processDailyForecast(list: any[]) {\n    const dailyMap = new Map();\n\n    list.forEach((item) => {\n        const date = new Date(item.dt * 1000).toLocaleDateString();\n        if (!dailyMap.has(date)) {\n            dailyMap.set(date, {\n                dt: item.dt,\n                temp_max: item.main.temp_max,\n                temp_min: item.main.temp_min,\n                icon: item.weather[0].icon,\n                condition: item.weather[0].main,\n            });\n        } else {\n            const existing = dailyMap.get(date);\n            existing.temp_max = Math.max(existing.temp_max, item.main.temp_max);\n            existing.temp_min = Math.min(existing.temp_min, item.main.temp_min);\n            // Update icon to midday if possible, or just keep first\n        }\n    });\n\n    return Array.from(dailyMap.values()).slice(0, 5).map((item: any) => ({\n        ...item,\n        temp_max: Math.round(item.temp_max),\n        temp_min: Math.round(item.temp_min)\n    }));\n}\n\nfunction getMockData(city: string): WeatherData {\n    return {\n        current: {\n            temp: 72,\n            condition: \"Clear\",\n            description: \"clear sky\",\n            high: 78,\n            low: 65,\n            city: city,\n            feelsLike: 70,\n            humidity: 60,\n            pressure: 1013,\n            windSpeed: 2.1,\n            windDeg: 180,\n            visibility: 10000,\n        },\n        hourly: Array.from({ length: 8 }).map((_, i) => ({\n            dt: Math.floor(Date.now() / 1000) + i * 3600,\n            temp: 70 + Math.floor(Math.random() * 10),\n            icon: \"01d\",\n        })),\n        daily: Array.from({ length: 5 }).map((_, i) => ({\n            dt: Math.floor(Date.now() / 1000) + i * 86400,\n            temp_max: 80 + Math.floor(Math.random() * 5),\n            temp_min: 60 + Math.floor(Math.random() * 5),\n            icon: \"01d\",\n            condition: \"Clear\",\n        })),\n        timezoneOffset: 0, // UTC for mock data\n    };\n}\n"],"names":[],"mappings":"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"}}]
}